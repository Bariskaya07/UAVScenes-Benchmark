# =========================================================================
# CMNeXt DELIVER Configuration
# RGB + LiDAR (1-ch stacked to 3-ch) Multi-Modal Semantic Segmentation
# Target: Cross-dataset evaluation with UAVScenes
#
# Architecture:
# - RGB: MiT-B2 backbone (ImageNet pretrained)
# - LiDAR: PPX encoder (random init) - as per paper Section 3.3
# =========================================================================

# -------------------------------------------------------------------------
# DEVICE & OUTPUT
# -------------------------------------------------------------------------
DEVICE: cuda
SAVE_DIR: 'output/DELIVER_CMNeXt_B2'
SEED: 42                     # Reproducibility

# -------------------------------------------------------------------------
# MODEL CONFIG
# -------------------------------------------------------------------------
MODEL:
  NAME: CMNeXt
  BACKBONE: mit_b2           # SegFormer-B2 Backbone
  PRETRAINED: checkpoints/pretrained/mit_b2.pth
  NUM_CLASSES: 25            # DELIVER 25 classes
  EMBED_DIM: 768             # Decoder embedding dimension
  AUX_IN_CHANS: 3            # LiDAR: 1-ch stacked to 3-ch

# -------------------------------------------------------------------------
# DATASET CONFIG
# -------------------------------------------------------------------------
DATASET:
  NAME: DELIVER
  ROOT: data/DELIVER         # Symlink to actual data
  IGNORE_LABEL: 255          # Ignore index for loss computation
  AUX_CHANNELS: 3            # LiDAR: 1-ch stacked to 3-ch
  MODALS:
    - img                    # RGB (hub modality)
    - lidar                  # LiDAR (auxiliary)
  # ImageNet normalization for RGB
  MEAN:
    - 0.485
    - 0.456
    - 0.406
  STD:
    - 0.229
    - 0.224
    - 0.225

# -------------------------------------------------------------------------
# TRAINING CONFIG
# -------------------------------------------------------------------------
TRAIN:
  IMAGE_SIZE:
    - 1024
    - 1024                   # DELIVER native resolution
  BATCH_SIZE: 4              # Reduced for larger images
  GRAD_ACCUM: 2              # Effective batch 8
  EPOCHS: 60                 # Training epochs
  EVAL_START: 5              # Start evaluation after epoch 5
  EVAL_INTERVAL: 5           # Evaluate every 5 epochs
  AMP: true                  # Mixed Precision for memory efficiency
  DDP: false                 # Single GPU mode
  WORKERS: 8                 # Data loading workers

  # Early Stopping
  EARLY_STOP:
    ENABLE: true
    PATIENCE: 3
    MIN_DELTA: 0.001
    METRIC: 'mIoU'

# -------------------------------------------------------------------------
# LOSS FUNCTION
# -------------------------------------------------------------------------
LOSS:
  NAME: CrossEntropy
  IGNORE_INDEX: 255

# -------------------------------------------------------------------------
# OPTIMIZER & SCHEDULER
# -------------------------------------------------------------------------
OPTIMIZER:
  NAME: AdamW
  LR: 0.00006
  WEIGHT_DECAY: 0.01
  BETAS:
    - 0.9
    - 0.999

SCHEDULER:
  NAME: PolyLR
  MAX_EPOCHS: 60
  POWER: 1.0
  WARMUP_TYPE: linear
  WARMUP_EPOCHS: 3
  WARMUP_RATIO: 0.000001

# -------------------------------------------------------------------------
# EVALUATION CONFIG (Sliding Window)
# -------------------------------------------------------------------------
EVAL:
  MODEL_PATH: ''
  IMAGE_SIZE:
    - 1024
    - 1024
  BATCH_SIZE: 1
  MODE: 'slide'
  STRIDE:
    - 512
    - 512
  CROP_SIZE:
    - 1024
    - 1024

TEST:
  MODE: 'slide'
  STRIDE:
    - 512
    - 512
  CROP_SIZE:
    - 1024
    - 1024

# -------------------------------------------------------------------------
# AUGMENTATION CONFIG
# -------------------------------------------------------------------------
AUGMENTATION:
  TRAIN:
    RANDOM_RESIZE:
      ENABLE: true
      SCALE:
        - 0.5
        - 2.0
    RANDOM_CROP:
      ENABLE: true
      SIZE:
        - 1024
        - 1024
    RANDOM_HFLIP:
      ENABLE: true
      PROB: 0.5
    PHOTOMETRIC:
      ENABLE: true
      BRIGHTNESS: 0.2
      CONTRAST: 0.2
      SATURATION: 0.2
      HUE: 0.1
    GAUSSIAN_BLUR:
      ENABLE: true
      PROB: 0.5
      KERNEL_SIZE: 5

  TEST:
    NORMALIZE_ONLY: true

# -------------------------------------------------------------------------
# LOGGING
# -------------------------------------------------------------------------
LOGGING:
  TENSORBOARD: true
  LOG_INTERVAL: 50
  SAVE_BEST_ONLY: true
  SAVE_INTERVAL: 10
